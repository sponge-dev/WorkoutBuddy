{% extends "base.html" %}

{% block title %}Dashboard - WorkoutBot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2 mb-4">
            Performance Dashboard
        </h1>
    </div>
</div>

<!-- Quick Stats Row -->
<div class="row g-4 mb-5">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-number" id="totalWorkouts">-</div>
            <div class="stat-label">Total Workouts</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-number" id="totalMinutes">-</div>
            <div class="stat-label">Minutes Trained</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-number" id="currentWeight">-</div>
            <div class="stat-label">Current Weight (kg)</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-number" id="currentBMI">-</div>
            <div class="stat-label">Current BMI</div>
        </div>
    </div>
</div>

<!-- Main Dashboard Row -->
<div class="row g-4">
    <!-- Weight Progress Chart -->
    <div class="col-lg-8">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    Weight Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Progress Entry -->
    <div class="col-lg-4">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    Daily Progress Entry
                </h5>
            </div>
            <div class="card-body">
                <form id="quickProgressForm">
                    <div class="mb-3">
                        <label for="todayWeight" class="form-label">Weight (kg)</label>
                        <input type="number" class="form-control" id="todayWeight" step="0.1" placeholder="Enter weight">
                    </div>
                    <div class="mb-3">
                        <label for="todayBodyFat" class="form-label">Body Fat %</label>
                        <input type="number" class="form-control" id="todayBodyFat" step="0.1" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label for="todayNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="todayNotes" rows="2" placeholder="Additional observations"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        Submit Data
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Workout Frequency Chart -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    Training Frequency Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Workouts -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    Recent Training Sessions
                </h5>
            </div>
            <div class="card-body">
                <div id="recentWorkouts">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-dumbbell fa-2x mb-3"></i>
                        <p>No recent workouts found</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Body Measurements -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    Anthropometric Data
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="measurementsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Goals Progress -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    Objective Tracking
                </h5>
            </div>
            <div class="card-body">
                <div id="goalsProgress">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-bullseye fa-2x mb-3"></i>
                        <p>Set up your goals to track progress</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chatbot and Past Workout Section -->
<div class="row g-4 mt-4">
    <!-- AI Fitness Coach Chatbot -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    Training Consultation
                </h5>
            </div>
            <div class="card-body">
                <div id="chatMessages" class="chat-container mb-3" style="height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                    <div class="text-center text-muted">
                        <p>Training guidance and exercise consultation available</p>
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="Enter your training question..." onkeypress="handleChatKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Log Past Workout -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    Historical Session Entry
                </h5>
            </div>
            <div class="card-body">
                <form id="pastWorkoutForm">
                    <div class="mb-3">
                        <label for="pastWorkoutName" class="form-label">Workout Name</label>
                        <input type="text" class="form-control" id="pastWorkoutName" required placeholder="e.g., Morning Run">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label for="pastWorkoutDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="pastWorkoutDate" required>
                        </div>
                        <div class="col-6">
                            <label for="pastWorkoutDuration" class="form-label">Duration (min)</label>
                            <input type="number" class="form-control" id="pastWorkoutDuration" placeholder="60">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="pastWorkoutNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="pastWorkoutNotes" rows="2" placeholder="Session summary and observations"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        Submit Entry
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Row -->
<div class="row g-4 mt-4">
    <div class="col-md-3">
        <button class="btn btn-success w-100 py-3" onclick="window.location.href='/workout-plan'">
            Create Training Program
        </button>
    </div>
    <div class="col-md-3">
        <button class="btn btn-primary w-100 py-3" onclick="window.location.href='/progress'">
            <i class="fas fa-chart-bar me-2"></i>View Detailed Progress
        </button>
    </div>
    <div class="col-md-3">
        <button class="btn btn-warning w-100 py-3" data-bs-toggle="modal" data-bs-target="#workoutModal">
            <i class="fas fa-play me-2"></i>Start Workout Session
        </button>
    </div>
    <div class="col-md-3">
        <button class="btn btn-info w-100 py-3" onclick="showDatabaseInfo()">
            <i class="fas fa-database me-2"></i>Database Info
        </button>
    </div>
</div>

<!-- Workout Session Modal -->
<div class="modal fade" id="workoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play me-2"></i>Start Workout Session
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="workoutSessionForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="workoutName" class="form-label">Workout Name</label>
                            <input type="text" class="form-control" id="workoutName" required placeholder="e.g., Upper Body Strength">
                        </div>
                        <div class="col-md-6">
                            <label for="workoutDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="workoutDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="estimatedDuration" class="form-label">Estimated Duration (minutes)</label>
                            <input type="number" class="form-control" id="estimatedDuration" placeholder="60">
                        </div>
                        <div class="col-md-6">
                            <label for="estimatedCalories" class="form-label">Estimated Calories</label>
                            <input type="number" class="form-control" id="estimatedCalories" placeholder="300">
                        </div>
                        <div class="col-12">
                            <label for="workoutNotes" class="form-label">Pre-workout Notes</label>
                            <textarea class="form-control" id="workoutNotes" rows="3" placeholder="How are you feeling? Any specific goals for today?"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="startWorkoutBtn">
                    <i class="fas fa-play me-2"></i>Start Workout
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let weightChart, frequencyChart, measurementsChart;

document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
    
    // Load dashboard data
    loadDashboardData();
    
    // Set up event listeners
    document.getElementById('quickProgressForm').addEventListener('submit', saveQuickProgress);
    document.getElementById('startWorkoutBtn').addEventListener('click', startWorkoutSession);
    document.getElementById('pastWorkoutForm').addEventListener('submit', logPastWorkout);
});

function loadDashboardData() {
    // Load statistics
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            updateQuickStats(data);
            createWeightChart(data.weight_progress || []);
            createFrequencyChart(data.monthly_workouts || {});
        })
        .catch(error => console.error('Error loading statistics:', error));
    
    // Load recent workouts
    fetch('/api/workout-sessions')
        .then(response => response.json())
        .then(data => {
            displayRecentWorkouts(data);
        })
        .catch(error => console.error('Error loading workouts:', error));
    
    // Load progress data for measurements
    fetch('/api/progress')
        .then(response => response.json())
        .then(data => {
            createMeasurementsChart(data);
        })
        .catch(error => console.error('Error loading progress:', error));
    
    // Load goals
    fetch('/api/goals')
        .then(response => response.json())
        .then(data => {
            displayGoalsProgress(data);
        })
        .catch(error => console.error('Error loading goals:', error));
}

function updateQuickStats(data) {
    document.getElementById('totalWorkouts').textContent = data.total_workouts || 0;
    document.getElementById('totalMinutes').textContent = data.total_minutes || 0;
    
    if (data.weight_progress && data.weight_progress.length > 0) {
        const latestWeight = data.weight_progress[data.weight_progress.length - 1].weight;
        document.getElementById('currentWeight').textContent = latestWeight;
        
        // Get user data for BMI calculation
        fetch('/api/user')
            .then(response => response.json())
            .then(userData => {
                if (userData.height) {
                    const bmi = calculateBMI(latestWeight, userData.height);
                    document.getElementById('currentBMI').textContent = bmi;
                }
            });
    }
}

function createWeightChart(weightData) {
    const ctx = document.getElementById('weightChart').getContext('2d');
    
    if (weightChart) {
        weightChart.destroy();
    }
    
    weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: weightData.map(d => new Date(d.date).toLocaleDateString()),
            datasets: [{
                label: 'Weight (kg)',
                data: weightData.map(d => d.weight),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function createFrequencyChart(monthlyData) {
    const ctx = document.getElementById('frequencyChart').getContext('2d');
    
    if (frequencyChart) {
        frequencyChart.destroy();
    }
    
    const labels = Object.keys(monthlyData).sort();
    const data = labels.map(month => monthlyData[month]);
    
    frequencyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            }),
            datasets: [{
                label: 'Workouts',
                data: data,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function createMeasurementsChart(progressData) {
    const ctx = document.getElementById('measurementsChart').getContext('2d');
    
    if (measurementsChart) {
        measurementsChart.destroy();
    }
    
    const validData = progressData.filter(d => d.chest || d.waist || d.arms);
    
    if (validData.length === 0) {
        ctx.canvas.parentElement.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-ruler fa-2x mb-3"></i>
                <p>No measurements recorded yet</p>
            </div>
        `;
        return;
    }
    
    measurementsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: validData.map(d => new Date(d.date).toLocaleDateString()),
            datasets: [
                {
                    label: 'Chest (cm)',
                    data: validData.map(d => d.chest),
                    borderColor: '#007bff',
                    backgroundColor: 'transparent',
                    borderWidth: 2
                },
                {
                    label: 'Waist (cm)',
                    data: validData.map(d => d.waist),
                    borderColor: '#28a745',
                    backgroundColor: 'transparent',
                    borderWidth: 2
                },
                {
                    label: 'Arms (cm)',
                    data: validData.map(d => d.arms),
                    borderColor: '#ffc107',
                    backgroundColor: 'transparent',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
}

function displayRecentWorkouts(workouts) {
    const container = document.getElementById('recentWorkouts');
    
    if (!workouts || workouts.length === 0) {
        return;
    }
    
    container.innerHTML = workouts.slice(0, 5).map(workout => `
        <div class="workout-session ${workout.completed ? 'completed' : 'pending'}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${workout.name}</h6>
                    <small class="text-muted">${new Date(workout.date).toLocaleDateString()}</small>
                </div>
                <div class="text-end">
                    <span class="badge ${workout.completed ? 'bg-success' : 'bg-warning'}">
                        ${workout.completed ? 'Completed' : 'Pending'}
                    </span>
                    ${workout.duration_minutes ? `<div class="small text-muted">${workout.duration_minutes} min</div>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function displayGoalsProgress(goals) {
    const container = document.getElementById('goalsProgress');
    
    if (!goals || goals.length === 0) {
        return;
    }
    
    const activeGoal = goals[0]; // Display first active goal
    
    container.innerHTML = `
        <div class="mb-3">
            <h6 class="text-primary">${activeGoal.goal_type.charAt(0).toUpperCase() + activeGoal.goal_type.slice(1)} Goal</h6>
            <p class="mb-2">Target: ${activeGoal.target_weight ? activeGoal.target_weight + ' kg' : 'Not specified'}</p>
            <p class="mb-2">Frequency: ${activeGoal.workout_frequency} days/week</p>
            <p class="mb-2">Duration: ${activeGoal.workout_duration} minutes/session</p>
        </div>
        <button class="btn btn-outline-primary btn-sm" onclick="window.location.href='/'">
            <i class="fas fa-edit me-1"></i>Update Goals
        </button>
    `;
}

function saveQuickProgress(event) {
    event.preventDefault();
    
    const weight = document.getElementById('todayWeight').value;
    const bodyFat = document.getElementById('todayBodyFat').value;
    const notes = document.getElementById('todayNotes').value;
    
    if (!weight) {
        alert('Please enter your weight');
        return;
    }
    
    const progressData = {
        weight: parseFloat(weight),
        body_fat_percentage: bodyFat ? parseFloat(bodyFat) : null,
        notes: notes
    };
    
    fetch('/api/progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(progressData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Progress saved successfully!');
            document.getElementById('quickProgressForm').reset();
            loadDashboardData(); // Refresh charts
        }
    })
    .catch(error => {
        console.error('Error saving progress:', error);
        alert('Error saving progress. Please try again.');
    });
}

function startWorkoutSession() {
    const sessionData = {
        name: document.getElementById('workoutName').value,
        date: document.getElementById('workoutDate').value,
        duration_minutes: document.getElementById('estimatedDuration').value ? parseInt(document.getElementById('estimatedDuration').value) : null,
        calories_burned: document.getElementById('estimatedCalories').value ? parseInt(document.getElementById('estimatedCalories').value) : null,
        notes: document.getElementById('workoutNotes').value,
        completed: false
    };
    
    if (!sessionData.name || !sessionData.date) {
        alert('Please fill in the workout name and date');
        return;
    }
    
    fetch('/api/workout-sessions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(sessionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            bootstrap.Modal.getInstance(document.getElementById('workoutModal')).hide();
            alert('Workout session started! Good luck with your training!');
            loadDashboardData(); // Refresh recent workouts
        }
    })
    .catch(error => {
        console.error('Error starting workout:', error);
        alert('Error starting workout session. Please try again.');
    });
}

function calculateBMI(weight, height) {
    const heightInMeters = height / 100;
    return Math.round(weight / (heightInMeters * heightInMeters) * 10) / 10;
}

// Chatbot functionality
function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    const chatContainer = document.getElementById('chatMessages');
    
    // Clear welcome message if present
    if (chatContainer.querySelector('.text-center')) {
        chatContainer.innerHTML = '';
    }
    
    // Add user message
    addChatMessage('user', message);
    input.value = '';
    
    // Add loading message
    addChatMessage('bot', '<i class="fas fa-spinner fa-spin"></i> Thinking...', 'thinking');
    
    // Send to API
    fetch('/api/chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        // Remove thinking message
        const thinkingMsg = chatContainer.querySelector('.thinking');
        if (thinkingMsg) thinkingMsg.remove();
        
        if (data.response) {
            addChatMessage('bot', data.response);
        } else {
            addChatMessage('bot', 'Sorry, I encountered an error. Please try again.');
        }
    })
    .catch(error => {
        console.error('Chatbot error:', error);
        const thinkingMsg = chatContainer.querySelector('.thinking');
        if (thinkingMsg) thinkingMsg.remove();
        addChatMessage('bot', 'Sorry, I\'m having trouble connecting. Please try again later.');
    });
}

function addChatMessage(sender, message, className = '') {
    const chatContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender} mb-2 ${className}`;
    
    const isUser = sender === 'user';
    messageDiv.innerHTML = `
        <div class="d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'}">
            <div class="message-bubble ${isUser ? 'user-message' : 'bot-message'}" style="
                max-width: 80%; 
                padding: 8px 12px; 
                border-radius: 15px; 
                background-color: ${isUser ? '#007bff' : '#f8f9fa'}; 
                color: ${isUser ? 'white' : 'black'};
                border: ${isUser ? 'none' : '1px solid #ddd'};
            ">
                ${message}
            </div>
        </div>
    `;
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Past workout logging
function logPastWorkout(event) {
    event.preventDefault();
    
    const workoutData = {
        name: document.getElementById('pastWorkoutName').value,
        date: document.getElementById('pastWorkoutDate').value,
        duration_minutes: document.getElementById('pastWorkoutDuration').value ? parseInt(document.getElementById('pastWorkoutDuration').value) : null,
        notes: document.getElementById('pastWorkoutNotes').value
    };
    
    if (!workoutData.name || !workoutData.date) {
        alert('Please fill in the workout name and date');
        return;
    }
    
    fetch('/api/log-past-workout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(workoutData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Past workout logged successfully!');
            document.getElementById('pastWorkoutForm').reset();
            loadDashboardData(); // Refresh recent workouts
        } else {
            alert(data.error || 'Error logging workout');
        }
    })
    .catch(error => {
        console.error('Error logging past workout:', error);
        alert('Error logging workout. Please try again.');
    });
}

// Database info
function showDatabaseInfo() {
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            const dbLocation = data.database_location || 'workoutbot.db (in project root directory)';
            alert(`Database Information:
            
Location: ${dbLocation}

The database contains all your:
• User profile data
• Progress tracking
• Workout plans and sessions
• Goals and measurements

To backup your data, simply copy the workoutbot.db file to a safe location.`);
        })
        .catch(error => {
            console.error('Error getting database info:', error);
            alert('Database Location: workoutbot.db (in project root directory)');
        });
}
</script>
{% endblock %} 