{% extends "base.html" %}

{% block content %}
<div class="hero-section text-center py-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="display-4 fw-bold text-primary mb-4">
                Intelligent Fitness Management Platform
            </h1>
            <p class="lead mb-4">
                Advanced workout planning, comprehensive progress tracking, and data-driven fitness optimization powered by artificial intelligence
            </p>
            <button class="btn btn-primary btn-lg" id="setupBtn">
                Create Profile
            </button>
        </div>
    </div>
</div>

<!-- Feature Cards -->
<div class="row g-4 mb-5">
    <div class="col-md-6 col-lg-3">
        <div class="feature-card text-center">
            <div class="feature-icon">
                <i class="fas fa-brain"></i>
            </div>
            <h5>Intelligent Program Design</h5>
            <p>Customized training programs generated using advanced algorithms based on your specific objectives and capabilities</p>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="feature-card text-center">
            <div class="feature-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h5>Analytics & Monitoring</h5>
            <p>Comprehensive tracking of biometric data, performance metrics, and progress analysis with advanced visualization</p>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="feature-card text-center">
            <div class="feature-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <h5>Cross-Platform Access</h5>
            <p>Full-featured responsive design ensures seamless functionality across all devices and platforms</p>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="feature-card text-center">
            <div class="feature-icon">
                <i class="fas fa-database"></i>
            </div>
            <h5>Data Management</h5>
            <p>Secure local storage of training history with intelligent data analysis for continuous program optimization</p>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-4" id="quickStats" style="display: none;">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number" id="totalWorkouts">0</div>
            <div class="stat-label">Total Workouts</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number" id="totalMinutes">0</div>
            <div class="stat-label">Minutes Trained</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number" id="currentWeight">--</div>
            <div class="stat-label">Current Weight (lbs)</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number" id="currentBMI">--</div>
            <div class="stat-label">Current BMI</div>
        </div>
    </div>
</div>

<!-- User Setup Modal -->
<div class="modal fade" id="userSetupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">
                    User Profile Configuration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userSetupForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="userName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="userAge" class="form-label">Age</label>
                            <input type="number" class="form-control" id="userAge" min="13" max="100" required>
                        </div>
                        <div class="col-md-6">
                            <label for="userHeight" class="form-label">Height (inches)</label>
                            <input type="number" class="form-control" id="userHeight" min="48" max="84" step="0.5" placeholder="e.g., 70 for 5'10&quot;" required>
                        </div>
                        <div class="col-md-6">
                            <label for="userWeight" class="form-label">Current Weight (lbs)</label>
                            <input type="number" class="form-control" id="userWeight" min="80" max="500" step="0.1" placeholder="Enter current weight" required>
                        </div>
                        <div class="col-md-6">
                            <label for="userGender" class="form-label">Gender</label>
                            <select class="form-select" id="userGender" required>
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="fitnessLevel" class="form-label">Fitness Level</label>
                            <select class="form-select" id="fitnessLevel" required>
                                <option value="">Select Fitness Level</option>
                                <option value="beginner">Beginner (0-6 months experience)</option>
                                <option value="intermediate">Intermediate (6 months - 2 years)</option>
                                <option value="advanced">Advanced (2+ years experience)</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">
                    <i class="fas fa-save me-2"></i><span id="saveUserBtnText">Save Profile</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Goal Setup Modal -->
<div class="modal fade" id="goalSetupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-target me-2"></i>Set Your Fitness Goals
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="goalSetupForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="goalType" class="form-label">Primary Goal</label>
                            <select class="form-select" id="goalType" required>
                                <option value="">Select Goal</option>
                                <option value="bulk">Bulk (Build Muscle)</option>
                                <option value="cut">Cut (Lose Fat)</option>
                                <option value="tone">Tone (Lean & Defined)</option>
                                <option value="strength">Strength Training</option>
                                <option value="endurance">Endurance & Cardio</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="targetDate" class="form-label">Target Date</label>
                            <input type="date" class="form-control" id="targetDate">
                        </div>
                        <div class="col-md-6">
                            <label for="workoutFrequency" class="form-label">Workouts per Week</label>
                            <select class="form-select" id="workoutFrequency" required>
                                <option value="2">2 days</option>
                                <option value="3" selected>3 days</option>
                                <option value="4">4 days</option>
                                <option value="5">5 days</option>
                                <option value="6">6 days</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="workoutDuration" class="form-label">Session Duration (minutes)</label>
                            <select class="form-select" id="workoutDuration" required>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="equipmentAvailable" class="form-label">Available Equipment</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="bodyweight" id="eq_bodyweight" checked>
                                        <label class="form-check-label" for="eq_bodyweight">Bodyweight</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="dumbbells" id="eq_dumbbells">
                                        <label class="form-check-label" for="eq_dumbbells">Dumbbells</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="barbell" id="eq_barbell">
                                        <label class="form-check-label" for="eq_barbell">Barbell</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="resistance_bands" id="eq_bands">
                                        <label class="form-check-label" for="eq_bands">Resistance Bands</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="pull_up_bar" id="eq_pullup">
                                        <label class="form-check-label" for="eq_pullup">Pull-up Bar</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="gym_access" id="eq_gym">
                                        <label class="form-check-label" for="eq_gym">Full Gym Access</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGoalBtn">
                    <i class="fas fa-target me-2"></i>Save Goals
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUserData();
    loadQuickStats();
    
    // Check if we should open edit profile modal (from navigation redirect)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('edit_profile') === 'true') {
        setTimeout(() => {
            openEditProfile();
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 500);
    }
    
    // Setup button click handler
    document.getElementById('setupBtn').addEventListener('click', function() {
        resetModalForNewUser();
        bootstrap.Modal.getOrCreateInstance(document.getElementById('userSetupModal')).show();
    });
    
    // Save user profile
    document.getElementById('saveUserBtn').addEventListener('click', saveUserProfile);
    
    // Save goals
    document.getElementById('saveGoalBtn').addEventListener('click', saveUserGoals);
});

function loadUserData() {
    fetch('/api/user')
        .then(response => response.json())
        .then(data => {
            if (data.name) {
                document.querySelector('.hero-section h1').innerHTML = 
                    `<i class="fas fa-user-circle me-3"></i>Welcome back, ${data.name}!`;
                document.querySelector('.hero-section .btn').innerHTML = 
                    '<i class="fas fa-cog me-2"></i>Update Profile';
                document.querySelector('.hero-section .btn').onclick = openEditProfile;
                document.getElementById('quickStats').style.display = 'block';
            }
        })
        .catch(error => console.error('Error loading user data:', error));
}

function loadQuickStats() {
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalWorkouts').textContent = data.total_workouts;
            document.getElementById('totalMinutes').textContent = data.total_minutes;
            
            // Load latest progress for weight and BMI
            if (data.weight_progress && data.weight_progress.length > 0) {
                const latestWeight = data.weight_progress[data.weight_progress.length - 1].weight;
                document.getElementById('currentWeight').textContent = latestWeight;
                
                // Calculate BMI if we have user height
                fetch('/api/user')
                    .then(response => response.json())
                    .then(userData => {
                        if (userData.height) {
                            const bmi = calculateBMI(latestWeight, userData.height);
                            document.getElementById('currentBMI').textContent = bmi;
                        }
                    });
            }
        })
        .catch(error => console.error('Error loading stats:', error));
}

function saveUserProfile() {
    const isEditing = document.getElementById('userSetupForm').dataset.editing === 'true';
    
    const formData = {
        name: document.getElementById('userName').value,
        age: parseInt(document.getElementById('userAge').value),
        height: parseFloat(document.getElementById('userHeight').value),
        weight: parseFloat(document.getElementById('userWeight').value),
        gender: document.getElementById('userGender').value,
        fitness_level: document.getElementById('fitnessLevel').value
    };
    
    const url = isEditing ? '/api/user/update' : '/api/user';
    const method = isEditing ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            bootstrap.Modal.getInstance(document.getElementById('userSetupModal')).hide();
            
            if (isEditing) {
                alert('Profile updated successfully!');
                location.reload(); // Refresh to show updated data
            } else {
                setTimeout(() => {
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('goalSetupModal')).show();
                }, 500);
            }
        }
    })
    .catch(error => {
        console.error('Error saving user profile:', error);
        alert('Error saving profile. Please try again.');
    });
}

function saveUserGoals() {
    const equipment = [];
    document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        equipment.push(checkbox.value);
    });
    
    const formData = {
        goal_type: document.getElementById('goalType').value,
        target_date: document.getElementById('targetDate').value,
        workout_frequency: parseInt(document.getElementById('workoutFrequency').value),
        workout_duration: parseInt(document.getElementById('workoutDuration').value),
        equipment_available: equipment
    };
    
    fetch('/api/goals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            bootstrap.Modal.getInstance(document.getElementById('goalSetupModal')).hide();
            alert('Profile and goals saved! Redirecting to dashboard...');
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error saving goals:', error);
        alert('Error saving goals. Please try again.');
    });
}

function calculateBMI(weight, height) {
    // BMI = (weight in lbs / height in inches²) × 703
    if (!weight || !height || weight <= 0 || height <= 0) {
        return null;
    }
    
    const bmi = (weight / (height * height)) * 703;
    return Math.round(bmi * 10) / 10;
}

function openEditProfile() {
    // Load current user data and populate form
    fetch('/api/user')
        .then(response => response.json())
        .then(userData => {
            // Populate form fields
            document.getElementById('userName').value = userData.name || '';
            document.getElementById('userAge').value = userData.age || '';
            document.getElementById('userHeight').value = userData.height || '';
            document.getElementById('userGender').value = userData.gender || '';
            document.getElementById('fitnessLevel').value = userData.fitness_level || '';
            
            // Get latest weight from progress
            fetch('/api/progress')
                .then(response => response.json())
                .then(progressData => {
                    if (progressData.length > 0) {
                        const latestWeight = progressData[progressData.length - 1].weight;
                        document.getElementById('userWeight').value = latestWeight || '';
                    }
                })
                .catch(error => console.log('No progress data found'));
            
            // Set form to editing mode
            document.getElementById('userSetupForm').dataset.editing = 'true';
            document.getElementById('userModalTitle').textContent = 'Update Profile';
            document.getElementById('saveUserBtnText').textContent = 'Update Profile';
            
            // Show modal
            bootstrap.Modal.getOrCreateInstance(document.getElementById('userSetupModal')).show();
        })
        .catch(error => {
            console.error('Error loading user data:', error);
            alert('Error loading profile data. Please try again.');
        });
}

function resetModalForNewUser() {
    // Reset form for new user creation
    document.getElementById('userSetupForm').reset();
    document.getElementById('userSetupForm').dataset.editing = 'false';
    document.getElementById('userModalTitle').textContent = 'User Profile Configuration';
    document.getElementById('saveUserBtnText').textContent = 'Save Profile';
}
</script>
{% endblock %} 