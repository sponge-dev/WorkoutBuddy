{% extends "base.html" %}

{% block title %}Progress Tracking - WorkoutBot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2 mb-4">
            <i class="fas fa-chart-bar me-3"></i>Progress Tracking
        </h1>
    </div>
</div>

<!-- Progress Entry Form -->
<div class="row mb-5">
    <div class="col-lg-8 mx-auto">
        <div class="progress-form">
            <h4 class="mb-4">
                <i class="fas fa-plus-circle me-2"></i>Record Today's Progress
            </h4>
            <form id="progressForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="measurement-input">
                            <label for="progressDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="progressDate" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="measurement-input">
                            <label for="progressWeight" class="form-label">Weight (kg)</label>
                            <input type="number" class="form-control" id="progressWeight" step="0.1" placeholder="Enter weight">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="measurement-input">
                            <label for="progressBodyFat" class="form-label">Body Fat (%)</label>
                            <input type="number" class="form-control" id="progressBodyFat" step="0.1" placeholder="Optional">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="measurement-input">
                            <label for="progressMuscleMass" class="form-label">Muscle Mass (kg)</label>
                            <input type="number" class="form-control" id="progressMuscleMass" step="0.1" placeholder="Optional">
                        </div>
                    </div>
                </div>
                
                <h5 class="mt-4 mb-3">Body Measurements (cm)</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="measurement-input">
                            <label for="progressChest" class="form-label">Chest</label>
                            <input type="number" class="form-control" id="progressChest" step="0.1" placeholder="Chest circumference">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="measurement-input">
                            <label for="progressWaist" class="form-label">Waist</label>
                            <input type="number" class="form-control" id="progressWaist" step="0.1" placeholder="Waist circumference">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="measurement-input">
                            <label for="progressHips" class="form-label">Hips</label>
                            <input type="number" class="form-control" id="progressHips" step="0.1" placeholder="Hip circumference">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="measurement-input">
                            <label for="progressArms" class="form-label">Arms</label>
                            <input type="number" class="form-control" id="progressArms" step="0.1" placeholder="Bicep circumference">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="measurement-input">
                            <label for="progressThighs" class="form-label">Thighs</label>
                            <input type="number" class="form-control" id="progressThighs" step="0.1" placeholder="Thigh circumference">
                        </div>
                    </div>
                </div>
                
                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <div class="measurement-input">
                            <label for="progressNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="progressNotes" rows="3" placeholder="How are you feeling? Any observations about your progress?"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Save Progress
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Progress Charts -->
<div class="row g-4 mb-5">
    <!-- Weight Progress -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-weight me-2"></i>Weight Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="weightProgressChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Body Composition -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Body Composition
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="bodyCompositionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Body Measurements -->
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-ruler me-2"></i>Body Measurements Over Time
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="measurementsProgressChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BMI Calculator -->
<div class="row mb-5">
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>BMI Calculator
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="bmiWeight" class="form-label">Weight (kg)</label>
                        <input type="number" class="form-control" id="bmiWeight" step="0.1">
                    </div>
                    <div class="col-md-6">
                        <label for="bmiHeight" class="form-label">Height (cm)</label>
                        <input type="number" class="form-control" id="bmiHeight">
                    </div>
                    <div class="col-12">
                        <button type="button" class="btn btn-primary" onclick="calculateBMI()">
                            <i class="fas fa-calculator me-2"></i>Calculate BMI
                        </button>
                    </div>
                    <div class="col-12">
                        <div id="bmiResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Summary -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Progress Summary
                </h5>
            </div>
            <div class="card-body">
                <div id="progressSummary">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-line fa-2x mb-3"></i>
                        <p>Record some progress data to see your summary</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress History -->
<div class="row">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Progress History
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="progressTable">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Weight (kg)</th>
                                <th>Body Fat (%)</th>
                                <th>Chest (cm)</th>
                                <th>Waist (cm)</th>
                                <th>Arms (cm)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-database fa-2x mb-3"></i>
                                    <br>No progress data recorded yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Progress Modal -->
<div class="modal fade" id="photoProgressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-camera me-2"></i>Photo Progress
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <p class="text-muted">Photo progress feature coming soon!</p>
                    <p>Upload before/after photos to track visual progress</p>
                    <button class="btn btn-outline-primary">
                        <i class="fas fa-upload me-2"></i>Upload Photo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let weightChart, bodyCompositionChart, measurementsChart;

document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('progressDate').value = new Date().toISOString().split('T')[0];
    
    // Load user data for BMI calculator
    loadUserDataForBMI();
    
    // Load progress data
    loadProgressData();
    
    // Set up form submission
    document.getElementById('progressForm').addEventListener('submit', saveProgress);
});

function loadUserDataForBMI() {
    fetch('/api/user')
        .then(response => response.json())
        .then(data => {
            if (data.height) {
                document.getElementById('bmiHeight').value = data.height;
            }
        })
        .catch(error => console.error('Error loading user data:', error));
}

function loadProgressData() {
    fetch('/api/progress')
        .then(response => response.json())
        .then(data => {
            createWeightChart(data);
            createBodyCompositionChart(data);
            createMeasurementsChart(data);
            populateProgressTable(data);
            createProgressSummary(data);
        })
        .catch(error => console.error('Error loading progress data:', error));
}

function createWeightChart(progressData) {
    const ctx = document.getElementById('weightProgressChart').getContext('2d');
    
    if (weightChart) {
        weightChart.destroy();
    }
    
    const weightData = progressData.filter(d => d.weight);
    
    if (weightData.length === 0) {
        ctx.canvas.parentElement.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-weight fa-2x mb-3"></i>
                <p>No weight data recorded yet</p>
            </div>
        `;
        return;
    }
    
    weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: weightData.map(d => new Date(d.date).toLocaleDateString()),
            datasets: [{
                label: 'Weight (kg)',
                data: weightData.map(d => d.weight),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function createBodyCompositionChart(progressData) {
    const ctx = document.getElementById('bodyCompositionChart').getContext('2d');
    
    if (bodyCompositionChart) {
        bodyCompositionChart.destroy();
    }
    
    const latestData = progressData.find(d => d.body_fat_percentage && d.muscle_mass);
    
    if (!latestData) {
        ctx.canvas.parentElement.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-chart-pie fa-2x mb-3"></i>
                <p>No body composition data yet</p>
            </div>
        `;
        return;
    }
    
    const bodyFat = latestData.body_fat_percentage;
    const muscleMass = latestData.muscle_mass;
    const other = 100 - bodyFat - (muscleMass / latestData.weight * 100);
    
    bodyCompositionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Body Fat', 'Muscle Mass', 'Other'],
            datasets: [{
                data: [bodyFat, muscleMass / latestData.weight * 100, other],
                backgroundColor: ['#dc3545', '#28a745', '#ffc107'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createMeasurementsChart(progressData) {
    const ctx = document.getElementById('measurementsProgressChart').getContext('2d');
    
    if (measurementsChart) {
        measurementsChart.destroy();
    }
    
    const validData = progressData.filter(d => d.chest || d.waist || d.arms || d.thighs);
    
    if (validData.length === 0) {
        ctx.canvas.parentElement.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-ruler fa-2x mb-3"></i>
                <p>No measurement data recorded yet</p>
            </div>
        `;
        return;
    }
    
    measurementsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: validData.map(d => new Date(d.date).toLocaleDateString()),
            datasets: [
                {
                    label: 'Chest (cm)',
                    data: validData.map(d => d.chest),
                    borderColor: '#007bff',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4
                },
                {
                    label: 'Waist (cm)',
                    data: validData.map(d => d.waist),
                    borderColor: '#28a745',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4
                },
                {
                    label: 'Arms (cm)',
                    data: validData.map(d => d.arms),
                    borderColor: '#ffc107',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4
                },
                {
                    label: 'Thighs (cm)',
                    data: validData.map(d => d.thighs),
                    borderColor: '#dc3545',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function populateProgressTable(progressData) {
    const tbody = document.getElementById('progressTableBody');
    
    if (progressData.length === 0) {
        return;
    }
    
    tbody.innerHTML = progressData.map(entry => `
        <tr>
            <td>${new Date(entry.date).toLocaleDateString()}</td>
            <td>${entry.weight || '-'}</td>
            <td>${entry.body_fat_percentage || '-'}</td>
            <td>${entry.chest || '-'}</td>
            <td>${entry.waist || '-'}</td>
            <td>${entry.arms || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editProgress(${entry.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function createProgressSummary(progressData) {
    const container = document.getElementById('progressSummary');
    
    if (progressData.length === 0) {
        return;
    }
    
    const latest = progressData[0];
    const previous = progressData[1];
    
    let summary = `
        <div class="mb-3">
            <h6 class="text-primary">Latest Entry</h6>
            <p class="mb-1">Date: ${new Date(latest.date).toLocaleDateString()}</p>
            ${latest.weight ? `<p class="mb-1">Weight: ${latest.weight} kg</p>` : ''}
            ${latest.body_fat_percentage ? `<p class="mb-1">Body Fat: ${latest.body_fat_percentage}%</p>` : ''}
        </div>
    `;
    
    if (previous && latest.weight && previous.weight) {
        const weightChange = (latest.weight - previous.weight).toFixed(1);
        const changeClass = weightChange > 0 ? 'text-warning' : 'text-success';
        const changeIcon = weightChange > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
        
        summary += `
            <div class="mb-3">
                <h6 class="text-primary">Recent Change</h6>
                <p class="mb-1 ${changeClass}">
                    <i class="fas ${changeIcon} me-1"></i>
                    ${Math.abs(weightChange)} kg since last entry
                </p>
            </div>
        `;
    }
    
    const totalEntries = progressData.length;
    const firstEntry = progressData[progressData.length - 1];
    
    if (firstEntry && latest.weight && firstEntry.weight && totalEntries > 1) {
        const totalChange = (latest.weight - firstEntry.weight).toFixed(1);
        const totalChangeClass = totalChange > 0 ? 'text-warning' : 'text-success';
        
        summary += `
            <div class="mb-3">
                <h6 class="text-primary">Total Progress</h6>
                <p class="mb-1 ${totalChangeClass}">
                    ${Math.abs(totalChange)} kg change over ${totalEntries} entries
                </p>
            </div>
        `;
    }
    
    container.innerHTML = summary;
}

function saveProgress(event) {
    event.preventDefault();
    
    const progressData = {
        date: document.getElementById('progressDate').value,
        weight: document.getElementById('progressWeight').value ? parseFloat(document.getElementById('progressWeight').value) : null,
        body_fat_percentage: document.getElementById('progressBodyFat').value ? parseFloat(document.getElementById('progressBodyFat').value) : null,
        muscle_mass: document.getElementById('progressMuscleMass').value ? parseFloat(document.getElementById('progressMuscleMass').value) : null,
        chest: document.getElementById('progressChest').value ? parseFloat(document.getElementById('progressChest').value) : null,
        waist: document.getElementById('progressWaist').value ? parseFloat(document.getElementById('progressWaist').value) : null,
        hips: document.getElementById('progressHips').value ? parseFloat(document.getElementById('progressHips').value) : null,
        arms: document.getElementById('progressArms').value ? parseFloat(document.getElementById('progressArms').value) : null,
        thighs: document.getElementById('progressThighs').value ? parseFloat(document.getElementById('progressThighs').value) : null,
        notes: document.getElementById('progressNotes').value
    };
    
    if (!progressData.date) {
        alert('Please select a date');
        return;
    }
    
    // At least one measurement should be provided
    const hasMeasurement = Object.values(progressData).some(value => 
        typeof value === 'number' && value !== null
    );
    
    if (!hasMeasurement) {
        alert('Please enter at least one measurement');
        return;
    }
    
    fetch('/api/progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(progressData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Progress saved successfully!');
            document.getElementById('progressForm').reset();
            document.getElementById('progressDate').value = new Date().toISOString().split('T')[0];
            loadProgressData(); // Refresh charts and table
        }
    })
    .catch(error => {
        console.error('Error saving progress:', error);
        alert('Error saving progress. Please try again.');
    });
}

function calculateBMI() {
    const weight = parseFloat(document.getElementById('bmiWeight').value);
    const height = parseFloat(document.getElementById('bmiHeight').value);
    
    if (!weight || !height) {
        alert('Please enter both weight and height');
        return;
    }
    
    const bmi = weight / Math.pow(height / 100, 2);
    const bmiRounded = Math.round(bmi * 10) / 10;
    
    let category = '';
    let categoryClass = '';
    
    if (bmi < 18.5) {
        category = 'Underweight';
        categoryClass = 'text-info';
    } else if (bmi < 25) {
        category = 'Normal weight';
        categoryClass = 'text-success';
    } else if (bmi < 30) {
        category = 'Overweight';
        categoryClass = 'text-warning';
    } else {
        category = 'Obese';
        categoryClass = 'text-danger';
    }
    
    document.getElementById('bmiResult').innerHTML = `
        <div class="alert alert-light border">
            <h5 class="mb-2">Your BMI: <span class="${categoryClass}">${bmiRounded}</span></h5>
            <p class="mb-0">Category: <strong class="${categoryClass}">${category}</strong></p>
        </div>
    `;
}

function editProgress(entryId) {
    alert('Edit progress feature coming soon!');
}
</script>
{% endblock %} 